<!-- Profile Dashboard -->
<div class="profile-dashboard">
  <!-- Header -->
  <div class="profile-header fade-in-up">
    <h1 class="profile-title slide-in-left">Profile</h1>
    @if (currentUser()?.role === 'admin') {
      <button class="add-employee-btn slide-in-right">
        <i class="fas fa-plus"></i>
        Add Employee
      </button>
    }
  </div>

  <!-- Navigation Tabs -->
  <div class="profile-tabs fade-in-up">
    @for (tab of getVisibleTabs(); track tab.id) {
      <button 
        (click)="setActiveTab(tab.id)"
        class="tab-button animated-tab"
        [class.active]="tab.active">
        <i [class]="tab.icon"></i>
        {{ tab.label }}
      </button>
    }
  </div>

  <!-- Main Content -->
  <div class="profile-content">
    <!-- Left Column - Profile Card -->
    <div class="profile-sidebar fade-in-left">
      <!-- Profile Card -->
      <div class="profile-card animated-card">
        <div class="profile-avatar-container animated-avatar">
          <div class="profile-avatar hover-lift" (click)="triggerFileUpload()">
            @if (getProfileImageUrl()) {
              <img 
                [src]="imageService.getOptimizedProfileImageUrl(getProfileImageUrl()!, 'medium')" 
                alt="Profile Picture"
                class="avatar-image">
            }
            @if (!getProfileImageUrl()) {
              <div class="avatar-initials">
                {{ getUserInitials(currentUser()!) }}
              </div>
            }
            <div class="avatar-overlay">
              <i class="fas fa-camera"></i>
              <span>Edit Photo</span>
            </div>
            <input
              type="file"
              (change)="onFileSelected($event)"
              accept="image/png, image/jpeg, image/gif"
              class="hidden">
          </div>
        </div>
        
        <div class="profile-info">
          <h2 class="profile-name">{{ currentUser()?.name }}</h2>
          <p class="profile-id">#{{ currentUser()?.id?.slice(-8)?.toUpperCase() }}</p>
        </div>
      </div>

      <!-- About Section -->
      <div class="info-section animated-section">
        <h3 class="section-title">About</h3>
        <div class="info-item animated-item">
          <i class="fas fa-envelope info-icon"></i>
          <span>{{ currentUser()?.email }}</span>
        </div>
        @if (currentUser()?.phone) {
          <div class="info-item animated-item">
            <i class="fas fa-phone info-icon"></i>
            <span>{{ currentUser()?.phone }}</span>
          </div>
        }
        @if (currentUser()?.bio) {
          <div class="info-item animated-item">
            <i class="fas fa-user-circle info-icon"></i>
            <span>{{ currentUser()?.bio }}</span>
          </div>
        }
      </div>

      <!-- Address Section -->
      <div class="info-section animated-section">
        <h3 class="section-title">Address</h3>
        <div class="info-item animated-item">
          <i class="fas fa-map-marker-alt info-icon"></i>
          <span>{{ getUserAddress() }}</span>
        </div>
        <div class="info-item animated-item">
          <i class="fas fa-city info-icon"></i>
          <span>{{ getUserCity() }}</span>
        </div>
        <div class="info-item animated-item">
          <i class="fas fa-mail-bulk info-icon"></i>
          <span>{{ getUserPostalCode() }}</span>
        </div>
      </div>

      <!-- User Details Section -->
      <div class="info-section animated-section">
        <h3 class="section-title">User Details</h3>
        <div class="info-item">
          <i class="fas fa-calendar-alt info-icon"></i>
          <span>Joined {{ getJoinDate() }}</span>
        </div>
        <div class="info-item">
          <i class="fas fa-id-card info-icon"></i>
          <span>{{ currentUser()?.role | titlecase }}</span>
        </div>
        <div class="info-item">
          <i class="fas fa-shield-alt info-icon"></i>
          <span>{{ currentUser()?.isVerified ? 'Verified User' : 'Unverified User' }}</span>
        </div>
      </div>
    </div>

    <!-- Right Column - Tab Content -->
    <div class="profile-main fade-in-right">
      <!-- Overview Tab -->
      @if (activeTab() === 'overview') {
        <div class="tab-content animated-content fade-in-up">
        <!-- Business Information (only for business/admin users) -->
        @if (isBusinessOwner() || isAdmin()) {
          <div class="content-panel animated-panel">
          <div class="panel-header">
            <h3 class="panel-title">Business Information</h3>
            @if (canRegisterBusiness()) {
              <button class="add-info-btn hover-lift" (click)="navigateToMyBusiness()">+ Register Business</button>
            } @else {
              <button class="manage-business-btn hover-lift" (click)="navigateToMyBusiness()">Manage Business</button>
            }
          </div>
          @if (getUserBusinesses().length > 0) {
            <div class="business-table">
              <div class="table-header">
                <div class="table-cell">BUSINESS</div>
                <div class="table-cell">CATEGORY</div>
                <div class="table-cell">TRUST SCORE</div>
                <div class="table-cell">STATUS</div>
                <div class="table-cell">REVIEWS</div>
                <div class="table-cell">ACTIONS</div>
              </div>
              @for (business of getUserBusinesses(); track business.id) {
                <div class="table-row animated-row">
                <div class="table-cell">{{ business.name }}</div>
                <div class="table-cell">{{ business.category }}</div>
                <div class="table-cell">{{ business.trustScore }}% ({{ business.trustGrade }})</div>
                <div class="table-cell">
                  <span class="status-badge" [class.verified]="business.isVerified">
                    {{ business.isVerified ? 'Verified' : 'Pending' }}
                  </span>
                </div>
                <div class="table-cell">{{ business.totalReviews }}</div>
                <div class="table-cell">
                  <i class="fas fa-ellipsis-v"></i>
                </div>
                </div>
              }
            </div>
          } @else {
            <div class="empty-state">
              <i class="fas fa-building"></i>
              <h4>No Business Registered</h4>
              <p>You can register one business per account. Start by registering your business to manage your profile.</p>
              <button class="btn-primary" (click)="navigateToMyBusiness()">Register Your Business</button>
            </div>
          }
        </div>
        }

        <!-- Activity Panel -->
        <div class="content-panel">
          <div class="panel-header">
            <h3 class="panel-title">Recent Activity</h3>
          </div>
          @if (getRecentActivity().length > 0) {
            <div class="activity-list">
              @for (activity of getRecentActivity(); track activity.date) {
                <div class="activity-item">
                  <div class="activity-avatar">
                    @if (getProfileImageUrl()) {
                      <img [src]="getProfileImageUrl()" alt="User">
                    } @else {
                      <div class="avatar-initials">{{ getUserInitials(currentUser()!) }}</div>
                    }
                  </div>
                  <div class="activity-content">
                    <p class="activity-text">
                      {{ activity.action }} 
                      @if (activity.target) {
                        for <strong>{{ activity.target }}</strong>
                      }
                      @if (activity.verified !== undefined) {
                        <span class="verification-badge" [class.verified]="activity.verified">
                          {{ activity.verified ? '✓ Verified' : '⚠ Unverified' }}
                        </span>
                      }
                    </p>
                    <p class="activity-date">{{ activity.date | date:'MMM d, y' }}</p>
                  </div>
                </div>
              }
            </div>
          } @else {
            <div class="empty-state">
              <i class="fas fa-history"></i>
              <p>No recent activity</p>
            </div>
          }
          <a href="#" class="view-all-link">View all activity</a>
        </div>

        <!-- Trust Score Panel -->
        <div class="content-panel">
          <div class="panel-header">
            <h3 class="panel-title">
              @if (isBusinessOwner()) {
                Business Trust Score
              } @else if (isCustomer()) {
                Reviewer Credibility
              } @else {
                Trust Score
              }
            </h3>
          </div>
          <div class="trust-score-content">
            @if (isBusinessOwner()) {
              <div class="score-item">
                <span class="score-value">{{ getTrustScore() | number:'1.0-0' }}%</span>
                <span class="score-label">Average Business Trust Score</span>
              </div>
              <div class="score-item">
                <span class="score-value">{{ getUserStats().totalBusinesses }}</span>
                <span class="score-label">Total Businesses</span>
              </div>
              <div class="score-item">
                <span class="score-value">{{ getVerifiedBusinessesCount() }}</span>
                <span class="score-label">Verified Businesses</span>
              </div>
            } @else if (isCustomer()) {
              <div class="score-item">
                <span class="score-value">{{ getTrustScore() | number:'1.0-0' }}</span>
                <span class="score-label">Credibility Score</span>
              </div>
              <div class="score-item">
                <span class="score-value">{{ getAverageRating() | number:'1.1-1' }}/5</span>
                <span class="score-label">Average Rating Given</span>
              </div>
              <div class="score-item">
                <span class="score-value">{{ getVerifiedReviewsCount() }}</span>
                <span class="score-label">Verified Reviews</span>
              </div>
            } @else {
              <div class="score-item">
                <span class="score-value">{{ getTrustScore() | number:'1.0-0' }}</span>
                <span class="score-label">Overall Score</span>
              </div>
            }
            <div class="score-item">
              <span class="score-value">{{ getUserStats().totalReviews }}</span>
              <span class="score-label">Total Reviews</span>
            </div>
          </div>
          <a href="#" class="view-all-link">View detailed breakdown</a>
        </div>
      </div>
      }

      <!-- Business Info Tab -->
      @if (activeTab() === 'business') {
        <div class="tab-content animated-content fade-in-up">
        @if (isBusinessOwner() || isAdmin()) {
          <div class="content-panel">
            <h3 class="panel-title">Business Management</h3>
            <p class="panel-description">Manage your business profiles and verification status.</p>
            
            @if (getUserBusinesses().length > 0) {
              <div class="business-grid">
                @for (business of getUserBusinesses(); track business.id) {
                  <div class="business-card">
                    <div class="business-header">
                      <h4>{{ business.name }}</h4>
                      <span class="status-badge" [class.verified]="business.isVerified">
                        {{ business.isVerified ? 'Verified' : 'Pending' }}
                      </span>
                    </div>
                    <div class="business-details">
                      <p><strong>Category:</strong> {{ business.category }}</p>
                      <p><strong>Trust Score:</strong> {{ business.trustScore }}% ({{ business.trustGrade }})</p>
                      <p><strong>Reviews:</strong> {{ business.totalReviews }}</p>
                      <p><strong>Documents:</strong> {{ business.totalDocuments }}</p>
                      <p><strong>Payments:</strong> {{ business.totalPayments }}</p>
                      <p><strong>Created:</strong> {{ business.createdAt | date:'MMM d, y' }}</p>
                    </div>
                    <div class="business-actions">
                      <button class="btn-secondary">Edit</button>
                      <button class="btn-primary">View Details</button>
                    </div>
                  </div>
                }
              </div>
            } @else {
              <div class="empty-state">
                <i class="fas fa-building"></i>
                <h4>No Business Registered</h4>
                <p>You can register one business per account. Start by registering your business to manage your profile.</p>
                <button class="btn-primary" (click)="navigateToMyBusiness()">Register Your Business</button>
              </div>
            }
          </div>
        }
        </div>
      }

      <!-- Reviews Tab -->
      @if (activeTab() === 'reviews') {
        <div class="tab-content animated-content fade-in-up">
        @if (isCustomer() || isBusinessOwner()) {
          <div class="content-panel">
            <h3 class="panel-title">Your Reviews</h3>
            <p class="panel-description">View and manage your business reviews.</p>
            
            @if (getUserStats().totalReviews > 0) {
              <div class="reviews-summary">
                <div class="summary-card">
                  <h4>Review Summary</h4>
                  <div class="summary-stats">
                    <div class="stat-item">
                      <span class="stat-value">{{ getUserStats().totalReviews }}</span>
                      <span class="stat-label">Total Reviews</span>
                    </div>
                    @if (isCustomer()) {
                      <div class="stat-item">
                        <span class="stat-value">{{ getVerifiedReviewsCount() }}</span>
                        <span class="stat-label">Verified Reviews</span>
                      </div>
                      <div class="stat-item">
                        <span class="stat-value">{{ getAverageRating() | number:'1.1-1' }}/5</span>
                        <span class="stat-label">Average Rating</span>
                      </div>
                    }
                  </div>
                </div>
              </div>
              
              <div class="reviews-list">
                <h4>Recent Reviews</h4>
                @for (activity of getReviewActivities(); track activity.date) {
                  <div class="review-item">
                    <div class="review-header">
                      <h5>{{ activity.target }}</h5>
                      <span class="verification-badge" [class.verified]="activity.verified">
                        {{ activity.verified ? '✓ Verified' : '⚠ Unverified' }}
                      </span>
                    </div>
                    <p class="review-text">{{ activity.action }}</p>
                    <p class="review-date">{{ activity.date | date:'MMM d, y' }}</p>
                    @if (activity.credibility) {
                      <div class="credibility-score">
                        <span>Credibility: {{ activity.credibility }}%</span>
                      </div>
                    }
                    
                    <!-- Review Replies (only for business owners) -->
                    @if (isBusinessOwner() || isAdmin()) {
                      <app-review-reply 
                        [reviewId]="activity.id"
                        [replies]="getReviewReplies(activity.id)"
                        (replyAdded)="onReplyAdded($event)"
                        (replyUpdated)="onReplyUpdated($event)"
                        (replyDeleted)="onReplyDeleted($event)">
                      </app-review-reply>
                    }
                  </div>
                }
              </div>
            } @else {
              <div class="empty-state">
                <i class="fas fa-star"></i>
                <h4>No Reviews Yet</h4>
                @if (isCustomer()) {
                  <p>Start reviewing businesses to build your credibility score.</p>
                  <button class="btn-primary">Write Your First Review</button>
                } @else {
                  <p>As a business owner, you can reply to reviews but cannot write reviews yourself.</p>
                }
              </div>
            }
          </div>
        }
        </div>
      }

      <!-- Trust Score Tab -->
      @if (activeTab() === 'trust') {
        <div class="tab-content animated-content fade-in-up">
        <div class="content-panel">
          <h3 class="panel-title">Trust Score Details</h3>
          <p class="panel-description">Detailed breakdown of your trust score and reputation.</p>
          <!-- Trust score content will go here -->
        </div>
      </div>
      }

      <!-- Settings Tab -->
      @if (activeTab() === 'settings') {
        <div class="tab-content animated-content fade-in-up">
        <div class="content-panel">
          <h3 class="panel-title">Account Settings</h3>
          <form [formGroup]="profileForm" (ngSubmit)="onSubmit()" class="settings-form">
            <!-- Two-column layout for name and contact fields -->
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">First Name</label>
                <input
                  formControlName="firstName"
                  type="text"
                  class="form-input"
                  placeholder="Enter first name">
                @if (getFieldError('firstName')) {
                  <div class="form-error">
                    {{ getFieldError('firstName') }}
                  </div>
                }
              </div>

              <div class="form-group">
                <label class="form-label">Last Name</label>
                <input
                  formControlName="lastName"
                  type="text"
                  class="form-input"
                  placeholder="Enter last name">
                @if (getFieldError('lastName')) {
                  <div class="form-error">
                    {{ getFieldError('lastName') }}
                  </div>
                }
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Email Address</label>
                <input
                  formControlName="email"
                  type="email"
                  class="form-input"
                  placeholder="Enter email address"
                  readonly>
                @if (getFieldError('email')) {
                  <div class="form-error">
                    {{ getFieldError('email') }}
                  </div>
                }
              </div>

              <div class="form-group">
                <label class="form-label">Phone Number</label>
                <input
                  formControlName="phone"
                  type="tel"
                  class="form-input"
                  placeholder="Enter phone number">
                @if (getFieldError('phone')) {
                  <div class="form-error">
                    {{ getFieldError('phone') }}
                  </div>
                }
              </div>
            </div>

            <!-- Full-width bio field -->
            <div class="form-group">
              <label class="form-label">Bio</label>
              <textarea
                formControlName="bio"
                class="form-textarea"
                placeholder="Tell us about yourself"
                rows="4"></textarea>
              @if (getFieldError('bio')) {
                <div class="form-error">
                  {{ getFieldError('bio') }}
                </div>
              }
            </div>

            <button
              type="submit"
              [disabled]="isLoading()"
              class="save-btn">
              @if (isLoading()) {
                <div class="btn-loading">
                  <div class="spinner"></div>
                  Saving...
                </div>
              }
              @if (!isLoading()) {
                <div class="btn-content">
                  <i class="fas fa-save"></i>
                  Save Changes
                </div>
              }
            </button>
          </form>
        </div>

        <!-- General Settings -->
        <div class="content-panel">
          <h3 class="panel-title">General Settings</h3>
          <div class="settings-list">
            <!-- Theme Toggle -->
            <div class="setting-item">
              <div class="setting-info">
                <h4 class="setting-title">Theme</h4>
                <p class="setting-description">Choose your preferred theme</p>
              </div>
              <div class="setting-control">
                <div class="theme-toggle">
                  <button 
                    (click)="setTheme('light')"
                    [class.active]="currentTheme() === 'light'"
                    class="theme-btn light-theme">
                    <i class="fas fa-sun"></i>
                    Light
                  </button>
                  <button 
                    (click)="setTheme('dark')"
                    [class.active]="currentTheme() === 'dark'"
                    class="theme-btn dark-theme">
                    <i class="fas fa-moon"></i>
                    Dark
                  </button>
                </div>
              </div>
            </div>

            <!-- Email Notifications -->
            <div class="setting-item">
              <div class="setting-info">
                <h4 class="setting-title">Email Notifications</h4>
                <p class="setting-description">Receive notifications via email</p>
              </div>
              <div class="setting-control">
                <label class="toggle-switch">
                  <input 
                    type="checkbox" 
                    [checked]="emailNotifications()"
                    (change)="toggleEmailNotifications($event)">
                  <span class="slider"></span>
                </label>
              </div>
            </div>

            <!-- Push Notifications -->
            <div class="setting-item">
              <div class="setting-info">
                <h4 class="setting-title">Push Notifications</h4>
                <p class="setting-description">Receive browser push notifications</p>
              </div>
              <div class="setting-control">
                <label class="toggle-switch">
                  <input 
                    type="checkbox" 
                    [checked]="pushNotifications()"
                    (change)="togglePushNotifications($event)">
                  <span class="slider"></span>
                </label>
              </div>
            </div>

            <!-- Review Reminders -->
            <div class="setting-item">
              <div class="setting-info">
                <h4 class="setting-title">Review Reminders</h4>
                <p class="setting-description">Get reminded to leave reviews after transactions</p>
              </div>
              <div class="setting-control">
                <label class="toggle-switch">
                  <input 
                    type="checkbox" 
                    [checked]="reviewReminders()"
                    (change)="toggleReviewReminders($event)">
                  <span class="slider"></span>
                </label>
              </div>
            </div>

            <!-- Privacy Settings -->
            <div class="setting-item">
              <div class="setting-info">
                <h4 class="setting-title">Public Profile</h4>
                <p class="setting-description">Make your profile visible to other users</p>
              </div>
              <div class="setting-control">
                <label class="toggle-switch">
                  <input 
                    type="checkbox" 
                    [checked]="publicProfile()"
                    (change)="togglePublicProfile($event)">
                  <span class="slider"></span>
                </label>
              </div>
            </div>

            <!-- Language Selection -->
            <div class="setting-item">
              <div class="setting-info">
                <h4 class="setting-title">Language</h4>
                <p class="setting-description">Choose your preferred language</p>
              </div>
              <div class="setting-control">
                <select class="language-select" [value]="selectedLanguage()" (change)="onLanguageChange($event)">
                  <option value="en">English</option>
                  <option value="sw">Kiswahili</option>
                  <option value="fr">Français</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
      }
    </div>
  </div>
</div>